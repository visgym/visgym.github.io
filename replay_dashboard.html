<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent Replay Dashboard</title>
  <style>
    :root {
      --bg-primary: #1e1e1e;
      --bg-secondary: #252526;
      --bg-tertiary: #2d2d30;
      --text-primary: #e0e0e0;
      --text-secondary: #cccccc;
      --accent: #007acc;
      --accent-hover: #0098ff;
      --success: #4ec9b0;
      --border: #3e3e42;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .dashboard-container {
      display: flex;
      height: calc(100vh - 80px);
      overflow: hidden;
    }

    /* Header */
    .dashboard-header {
      height: 80px;
      background-color: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
    }

    .environment-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .environment-selector label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .environment-selector select {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      min-width: 300px;
      cursor: pointer;
      font-family: 'Segoe UI', sans-serif;
    }

    .environment-selector select:hover {
      border-color: var(--accent);
    }

    .environment-selector select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
    }

    /* Left Panel - Visuals */
    .left-panel {
      width: 60%;
      background-color: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      padding: 20px;
    }

    .step-indicator {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 20px;
      text-align: center;
      padding: 10px;
      background-color: var(--bg-tertiary);
      border-radius: 4px;
    }

    .image-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--bg-primary);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
      position: relative;
    }

    .agent-view-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: opacity 0.3s ease;
    }

    .image-placeholder {
      color: var(--text-secondary);
      font-size: 16px;
      text-align: center;
      padding: 40px;
    }

    .loading-spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Right Panel - Data & Logic */
    .right-panel {
      width: 40%;
      background-color: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 20px;
    }

    .info-card {
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-content {
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Design Context Card */
    .design-context {
      font-size: 14px;
    }

    /* Input Prompt Card */
    .prompt-text {
      font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      background-color: var(--bg-primary);
      padding: 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-secondary);
    }

    /* Model Decision Card */
    .action-output {
      background-color: var(--bg-primary);
      border: 2px solid var(--success);
      border-radius: 4px;
      padding: 16px;
      font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
      font-size: 16px;
      font-weight: 600;
      color: var(--success);
      text-align: center;
      box-shadow: 0 0 12px rgba(78, 201, 176, 0.2);
    }

    /* Navigation Controls */
    .navigation-controls {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      position: sticky;
      bottom: 0;
      background-color: var(--bg-secondary);
    }

    .nav-button {
      flex: 1;
      padding: 12px 24px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-family: 'Segoe UI', sans-serif;
    }

    .nav-button:hover {
      background-color: var(--accent-hover);
    }

    .nav-button:disabled {
      background-color: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .nav-button:active {
      transform: scale(0.98);
    }

    /* Scrollbar Styling */
    .right-panel::-webkit-scrollbar,
    .prompt-text::-webkit-scrollbar {
      width: 8px;
    }

    .right-panel::-webkit-scrollbar-track,
    .prompt-text::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    .right-panel::-webkit-scrollbar-thumb,
    .prompt-text::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .right-panel::-webkit-scrollbar-thumb:hover,
    .prompt-text::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* Loading State */
    .loading {
      opacity: 0.5;
      pointer-events: none;
    }

    .error-message {
      color: #f48771;
      background-color: rgba(244, 135, 113, 0.1);
      border: 1px solid #f48771;
      border-radius: 4px;
      padding: 12px;
      margin: 10px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="dashboard-header">
    <div class="header-title">AI Agent Replay Dashboard</div>
    <div class="environment-selector">
      <label for="envSelect">Environment:</label>
      <select id="envSelect" onchange="loadEnvironment(this.value)">
        <option value="">Select an environment...</option>
        <option value="ToyMaze3DEnv-v0">ToyMaze3DEnv-v0</option>
        <option value="sliding_block__SlidingBlockEnv-v0">SlidingBlockEnv-v0</option>
        <option value="video_unshuffle__VideoUnshuffleEnv-v0">VideoUnshuffleEnv-v0</option>
        <option value="FetchReachDiscrete-v4">FetchReachDiscrete-v4</option>
        <option value="counting__LVISCountingEnv-v0">LVISCountingEnv-v0</option>
        <option value="mental_rotation_3d__mental_rotation-3d">Mental Rotation 3D</option>
        <option value="mental_rotation__mental_rotation-v0">Mental Rotation</option>
        <option value="Jigsaw-v0">Jigsaw-v0</option>
        <option value="ToyMaze2DEnv-v0">ToyMaze2DEnv-v0</option>
        <option value="colorization__ColorizationEnv-v2">ColorizationEnv-v2</option>
        <option value="match_equation__MatchEquation-v0">MatchEquation-v0</option>
        <option value="FetchPickAndPlaceDiscrete-v4">FetchPickAndPlaceDiscrete-v4</option>
        <option value="match_move__MatchRotation-v0">MatchRotation-v0</option>
        <option value="mental_rotation-3d_objaverse-v0">Mental Rotation 3D Objaverse</option>
        <option value="patch_reassembly__PatchReassemblyEnv-v0">PatchReassemblyEnv-v0</option>
        <option value="ref_dot__RefCOCOPlusDotEnv-v0">RefCOCOPlusDotEnv-v0</option>
        <option value="stringsight">StringSight</option>
        <option value="zoom_in__ZoomInEnv-v0">ZoomInEnv-v0</option>
      </select>
    </div>
  </div>
  
  <div class="dashboard-container">
    <!-- Left Panel: Visuals -->
    <div class="left-panel">
      <div class="step-indicator" id="stepIndicator">Select an environment to start</div>
      <div class="image-container">
        <div id="imagePlaceholder" class="image-placeholder">No environment selected</div>
        <img id="agentViewImage" class="agent-view-image" style="display: none;" alt="Agent View" />
      </div>
    </div>

    <!-- Right Panel: Data & Logic -->
    <div class="right-panel">
      <!-- Card 1: Design Context / Goal -->
      <div class="info-card">
        <div class="card-title">Design Context / Goal</div>
        <div class="card-content design-context" id="designContext">
          Select an environment to view the task context and goal.
        </div>
      </div>

      <!-- Card 2: Input Prompt -->
      <div class="info-card">
        <div class="card-title">Input Prompt</div>
        <div class="card-content">
          <pre class="prompt-text" id="promptText">Waiting for environment selection...</pre>
        </div>
      </div>

      <!-- Card 3: Model Decision (Action) -->
      <div class="info-card">
        <div class="card-title">Model Decision (Action)</div>
        <div class="card-content">
          <div class="action-output" id="actionOutput">-</div>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="navigation-controls">
        <button class="nav-button" id="prevButton" onclick="navigateStep(-1)" disabled>← Previous</button>
        <button class="nav-button" id="nextButton" onclick="navigateStep(1)" disabled>Next →</button>
      </div>
    </div>
  </div>

  <script>
    // Available environments
    const environments = [
      'ToyMaze3DEnv-v0',
      'sliding_block__SlidingBlockEnv-v0',
      'video_unshuffle__VideoUnshuffleEnv-v0',
      'FetchReachDiscrete-v4',
      'counting__LVISCountingEnv-v0',
      'mental_rotation_3d__mental_rotation-3d',
      'mental_rotation__mental_rotation-v0',
      'Jigsaw-v0',
      'ToyMaze2DEnv-v0',
      'colorization__ColorizationEnv-v2',
      'match_equation__MatchEquation-v0',
      'FetchPickAndPlaceDiscrete-v4',
      'match_move__MatchRotation-v0',
      'mental_rotation-3d_objaverse-v0',
      'patch_reassembly__PatchReassemblyEnv-v0',
      'ref_dot__RefCOCOPlusDotEnv-v0',
      'stringsight',
      'zoom_in__ZoomInEnv-v0'
    ];

    let currentEnvironment = null;
    let currentStepIndex = 0;
    let traceData = [];
    let maxSteps = 0;

    // Load environment data
    async function loadEnvironment(envName) {
      if (!envName) {
        resetDashboard();
        return;
      }

      currentEnvironment = envName;
      currentStepIndex = 0;
      traceData = [];
      
      // Show loading state
      document.getElementById('stepIndicator').textContent = 'Loading environment...';
      document.getElementById('imagePlaceholder').innerHTML = '<div class="loading-spinner"></div>';
      document.getElementById('imagePlaceholder').style.display = 'block';
      document.getElementById('agentViewImage').style.display = 'none';
      document.getElementById('promptText').textContent = 'Loading...';
      document.getElementById('actionOutput').textContent = 'Loading...';
      document.getElementById('designContext').textContent = 'Loading environment data...';

      try {
        // Discover steps by trying to load files
        maxSteps = await discoverSteps(envName);
        
        if (maxSteps === 0) {
          throw new Error('No steps found for this environment');
        }

        // Load all step data
        await loadAllSteps(envName, maxSteps);
        
        // Update display
        updateDisplay();
        updateNavigationButtons();
      } catch (error) {
        console.error('Error loading environment:', error);
        document.getElementById('imagePlaceholder').innerHTML = 
          `<div class="error-message">Error loading environment: ${error.message}</div>`;
        document.getElementById('promptText').textContent = 'Error loading data';
        document.getElementById('actionOutput').textContent = 'Error';
        document.getElementById('designContext').textContent = 'Failed to load environment data.';
      }
    }

    // Discover number of steps by checking files
    async function discoverSteps(envName) {
      let maxStep = 0;
      // Try up to 100 steps
      for (let i = 0; i < 100; i++) {
        const imagePath = `static/appendix/${envName}/image_${i}.png`;
        try {
          const response = await fetch(imagePath, { method: 'HEAD' });
          if (response.ok) {
            maxStep = i + 1;
          } else {
            break;
          }
        } catch (e) {
          break;
        }
      }
      return maxStep;
    }

    // Load all steps data
    async function loadAllSteps(envName, maxSteps) {
      traceData = [];
      
      for (let i = 0; i < maxSteps; i++) {
        try {
          const [promptText, actionText] = await Promise.all([
            fetch(`static/appendix/${envName}/prompt_${i}.txt`).then(r => r.ok ? r.text() : ''),
            fetch(`static/appendix/${envName}/action_${i}.txt`).then(r => r.ok ? r.text() : '')
          ]);

          traceData.push({
            stepId: i + 1,
            imageUrl: `static/appendix/${envName}/image_${i}.png`,
            promptText: promptText.trim() || 'No prompt available',
            actionOutput: actionText.trim() || '-',
            designContext: extractContextFromPrompt(promptText)
          });
        } catch (error) {
          console.warn(`Error loading step ${i}:`, error);
        }
      }
    }

    // Extract context/goal from prompt (first few lines)
    function extractContextFromPrompt(promptText) {
      if (!promptText) return 'No context available';
      const lines = promptText.split('\n').filter(line => line.trim());
      // Get first meaningful paragraph (usually contains the goal)
      const contextLines = lines.slice(0, 3).join(' ');
      return contextLines.length > 200 ? contextLines.substring(0, 200) + '...' : contextLines;
    }

    // Update all display elements
    function updateDisplay() {
      if (traceData.length === 0 || currentStepIndex >= traceData.length) {
        return;
      }

      const currentData = traceData[currentStepIndex];
      
      // Update step indicator
      document.getElementById('stepIndicator').textContent = 
        `Step ${currentData.stepId} of ${traceData.length}`;
      
      // Update image
      const imageElement = document.getElementById('agentViewImage');
      const placeholderElement = document.getElementById('imagePlaceholder');
      
      imageElement.src = currentData.imageUrl;
      imageElement.style.display = 'block';
      placeholderElement.style.display = 'none';
      
      // Handle image load error
      imageElement.onerror = function() {
        imageElement.style.display = 'none';
        placeholderElement.textContent = 'Image not available';
        placeholderElement.style.display = 'block';
      };
      
      // Update design context
      document.getElementById('designContext').textContent = currentData.designContext;
      
      // Update prompt text
      document.getElementById('promptText').textContent = currentData.promptText;
      
      // Update action output
      document.getElementById('actionOutput').textContent = currentData.actionOutput;
    }

    // Update navigation button states
    function updateNavigationButtons() {
      document.getElementById('prevButton').disabled = currentStepIndex === 0;
      document.getElementById('nextButton').disabled = currentStepIndex >= traceData.length - 1;
    }

    // Navigate between steps
    function navigateStep(direction) {
      if (traceData.length === 0) return;
      
      const newIndex = currentStepIndex + direction;
      
      if (newIndex >= 0 && newIndex < traceData.length) {
        currentStepIndex = newIndex;
        updateDisplay();
        updateNavigationButtons();
      }
    }

    // Reset dashboard
    function resetDashboard() {
      traceData = [];
      currentStepIndex = 0;
      document.getElementById('stepIndicator').textContent = 'Select an environment to start';
      document.getElementById('imagePlaceholder').textContent = 'No environment selected';
      document.getElementById('imagePlaceholder').style.display = 'block';
      document.getElementById('agentViewImage').style.display = 'none';
      document.getElementById('promptText').textContent = 'Waiting for environment selection...';
      document.getElementById('actionOutput').textContent = '-';
      document.getElementById('designContext').textContent = 'Select an environment to view the task context and goal.';
      updateNavigationButtons();
    }

    // Keyboard navigation support
    document.addEventListener('keydown', function(event) {
      // Prevent navigation if user is typing in an input field
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return;
      }
      
      if (event.key === 'ArrowLeft') {
        event.preventDefault();
        navigateStep(-1);
      } else if (event.key === 'ArrowRight') {
        event.preventDefault();
        navigateStep(1);
      }
    });

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
      // Optionally load first environment by default
      // loadEnvironment('ToyMaze3DEnv-v0');
    });
  </script>
</body>
</html>
