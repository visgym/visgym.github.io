<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <title>AI Agent Replay Dashboard</title>
  <link rel="stylesheet" href="static/css/replay_dashboard.css">
</head>
<body>
  <div class="dashboard-shell">
    <div class="dashboard-header">
      <div class="header-title">AI Agent Replay Dashboard</div>
    </div>
    
    <!-- All Envs Marquee / Grid -->
    <div class="environment-nav-container">
      <div class="environment-nav-scroll" id="environmentNavScroll">
        <div class="environment-cards-wrapper" id="environmentCardsWrapper" translate="no">
      <div class="environment-card" data-env="ToyMaze3DEnv-v0" onclick="selectEnvironment('ToyMaze3DEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/ToyMaze3DEnv-v0/image_0.png" alt="ToyMaze3D" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EToyMaze3D%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">ToyMaze3D</div>
      </div>
      <div class="environment-card" data-env="sliding_block__SlidingBlockEnv-v0" onclick="selectEnvironment('sliding_block__SlidingBlockEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/sliding_block__SlidingBlockEnv-v0/image_0.png" alt="SlidingBlock" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ESlidingBlock%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">SlidingBlock</div>
      </div>
      <div class="environment-card" data-env="video_unshuffle__VideoUnshuffleEnv-v0" onclick="selectEnvironment('video_unshuffle__VideoUnshuffleEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/video_unshuffle__VideoUnshuffleEnv-v0/image_0.png" alt="VideoUnshuffle" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EVideoUnshuffle%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">VideoUnshuffle</div>
      </div>
      <div class="environment-card" data-env="FetchReachDiscrete-v4" onclick="selectEnvironment('FetchReachDiscrete-v4')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/FetchReachDiscrete-v4/image_0.png" alt="FetchReach" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EFetchReach%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">FetchReach</div>
      </div>
      <div class="environment-card" data-env="counting__LVISCountingEnv-v0" onclick="selectEnvironment('counting__LVISCountingEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/counting__LVISCountingEnv-v0/image_0.png" alt="LVISCounting" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ELVISCounting%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">LVISCounting</div>
      </div>
      <div class="environment-card" data-env="mental_rotation_3d__mental_rotation-3d" onclick="selectEnvironment('mental_rotation_3d__mental_rotation-3d')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/mental_rotation_3d__mental_rotation-3d/image_0.png" alt="Mental Rotation 3D" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMental 3D%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Mental Rotation 3D</div>
      </div>
      <div class="environment-card" data-env="mental_rotation__mental_rotation-v0" onclick="selectEnvironment('mental_rotation__mental_rotation-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/mental_rotation__mental_rotation-v0/image_0.png" alt="Mental Rotation" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMental Rotation%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Mental Rotation</div>
      </div>
      <div class="environment-card" data-env="Jigsaw-v0" onclick="selectEnvironment('Jigsaw-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/Jigsaw-v0/image_0.png" alt="Jigsaw" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EJigsaw%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Jigsaw</div>
      </div>
      <div class="environment-card" data-env="ToyMaze2DEnv-v0" onclick="selectEnvironment('ToyMaze2DEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/ToyMaze2DEnv-v0/image_0.png" alt="ToyMaze2D" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EToyMaze2D%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">ToyMaze2D</div>
      </div>
      <div class="environment-card" data-env="colorization__ColorizationEnv-v2" onclick="selectEnvironment('colorization__ColorizationEnv-v2')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/colorization__ColorizationEnv-v2/image_0.png" alt="Colorization" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EColorization%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Colorization</div>
      </div>
      <div class="environment-card" data-env="match_equation__MatchEquation-v0" onclick="selectEnvironment('match_equation__MatchEquation-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/match_equation__MatchEquation-v0/image_0.png" alt="MatchEquation" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMatchEquation%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">MatchEquation</div>
      </div>
      <div class="environment-card" data-env="FetchPickAndPlaceDiscrete-v4" onclick="selectEnvironment('FetchPickAndPlaceDiscrete-v4')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/FetchPickAndPlaceDiscrete-v4/image_0.png" alt="FetchPickPlace" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EFetchPickPlace%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">FetchPickPlace</div>
      </div>
      <div class="environment-card" data-env="match_move__MatchRotation-v0" onclick="selectEnvironment('match_move__MatchRotation-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/match_move__MatchRotation-v0/image_0.png" alt="MatchRotation" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMatchRotation%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">MatchRotation</div>
      </div>
      <div class="environment-card" data-env="mental_rotation-3d_objaverse-v0" onclick="selectEnvironment('mental_rotation-3d_objaverse-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/mental_rotation-3d_objaverse-v0/image_0.png" alt="Mental 3D Objaverse" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMental 3D Objaverse%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Mental 3D Objaverse</div>
      </div>
      <div class="environment-card" data-env="patch_reassembly__PatchReassemblyEnv-v0" onclick="selectEnvironment('patch_reassembly__PatchReassemblyEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/patch_reassembly__PatchReassemblyEnv-v0/image_0.png" alt="PatchReassembly" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EPatchReassembly%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">PatchReassembly</div>
      </div>
      <div class="environment-card" data-env="ref_dot__RefCOCOPlusDotEnv-v0" onclick="selectEnvironment('ref_dot__RefCOCOPlusDotEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/ref_dot__RefCOCOPlusDotEnv-v0/image_0.png" alt="RefCOCOPlus" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ERefCOCOPlus%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">RefCOCOPlus</div>
      </div>
      <div class="environment-card" data-env="zoom_in__ZoomInEnv-v0" onclick="selectEnvironment('zoom_in__ZoomInEnv-v0')" translate="no">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/zoom_in__ZoomInEnv-v0/image_0.png" alt="ZoomIn" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EZoomIn%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">ZoomIn</div>
      </div>
        </div>
      </div>
    </div>
  
    <!-- Mission Data Card and Goal - Between Navigation and Dashboard -->
    <div class="mission-data-container" id="missionDataContainer">
      <div class="info-card mission-data-card" id="environmentInfoCard">
        <div class="mission-header">
          <span class="mission-title">// LEVEL_CONFIG_LOADED</span>
          <span class="cursor-blink">_</span>
        </div>
        <div class="mission-content">
          <div class="mission-stats">
            <div class="stat-item">
              <div class="stat-icon">█</div>
              <div class="stat-info">
                <div class="stat-label">DOMAIN</div>
                <div class="stat-bar">
                  <div class="stat-bar-fill" id="statDomainBar"></div>
                  <span class="stat-value" id="infoDomain">-</span>
                </div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">█</div>
              <div class="stat-info">
                <div class="stat-label">OBSERVABILITY</div>
                <div class="stat-bar">
                  <div class="stat-bar-fill" id="statObsBar"></div>
                  <span class="stat-value" id="infoObs">-</span>
                </div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">█</div>
              <div class="stat-info">
                <div class="stat-label">DYNAMICS</div>
                <div class="stat-bar">
                  <div class="stat-bar-fill" id="statDynBar"></div>
                  <span class="stat-value" id="infoDyn">-</span>
                </div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">█</div>
              <div class="stat-info">
                <div class="stat-label">PARAMETERS</div>
                <div class="stat-bar">
                  <div class="stat-bar-fill" id="statPBar"></div>
                  <span class="stat-value" id="infoP">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Goal Card - Parallel to Mission Data Card -->
      <div class="info-card goal-card" id="goalCard">
        <div class="goal-label">TARGET</div>
        <div class="goal-content-wrapper">
          <div class="goal-content design-context" id="designContext">
            Select an environment to view the task context and goal.<span class="goal-cursor">█</span>
          </div>
        </div>
      </div>
    </div>
  
    <div class="dashboard-container" id="dashboardContainer">
      <!-- Left Panel: Visuals -->
      <div class="left-panel">
        <div class="image-container">
          <div id="imagePlaceholder" class="image-placeholder">No environment selected</div>
          <img id="agentViewImage" class="agent-view-image" style="display: none;" alt="Agent View" />
        </div>
      </div>

      <!-- Right Panel: Data & Logic -->
      <div class="right-panel">
        <!-- Tri-Core Console -->
        <div class="console-container">
          <!-- Monitor 01: Feedback -->
          <div class="monitor-wrapper" id="feedbackMonitor">
            <div class="monitor-frame">
              <div class="monitor-header">
                <span class="monitor-label">MONITOR_01</span>
                <span class="monitor-status">●</span>
              </div>
              <div class="monitor-screen">
                <div class="monitor-title">FEEDBACK</div>
                <div class="monitor-content">
                  <div class="feedback-text" id="promptText">Waiting for environment selection...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Console Cable -->
          <div class="console-cable" id="consoleCable"></div>
          
          <!-- Monitor 02: Action -->
          <div class="monitor-wrapper">
            <div class="monitor-frame">
              <div class="monitor-header">
                <span class="monitor-label">MONITOR_02</span>
                <span class="monitor-status">●</span>
              </div>
              <div class="monitor-screen">
                <div class="monitor-title">ACTION</div>
                <div class="monitor-content">
                  <div class="action-terminal" id="actionOutput">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Player Controls -->
    <div class="bottom-player-controls">
      <div class="player-controls-container">
        <div class="player-progress-section">
          <div class="step-indicator" id="stepIndicator">Select an environment to start</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
        </div>
        
        <div class="player-buttons-group">
          <button class="player-nav-button" id="firstButton" onclick="navigateToStep(0)" disabled>
            <span class="player-button-icon">⏮</span>
          </button>
          <button class="player-nav-button" id="prevButton" onclick="navigateStep(-1)" disabled>
            <span class="player-button-icon">◀</span>
          </button>
          <button class="player-nav-button player-play-button" id="playPauseButton" onclick="togglePlayPause()">
            <span class="player-button-icon" id="playPauseIcon">⏸</span>
          </button>
          <button class="player-nav-button" id="nextButton" onclick="navigateStep(1)" disabled>
            <span class="player-button-icon">▶</span>
          </button>
          <button class="player-nav-button" id="lastButton" onclick="navigateToStep(-1)" disabled>
            <span class="player-button-icon">⏭</span>
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Available environments
    const environments = [
      'ToyMaze3DEnv-v0',
      'sliding_block__SlidingBlockEnv-v0',
      'video_unshuffle__VideoUnshuffleEnv-v0',
      'FetchReachDiscrete-v4',
      'counting__LVISCountingEnv-v0',
      'mental_rotation_3d__mental_rotation-3d',
      'mental_rotation__mental_rotation-v0',
      'Jigsaw-v0',
      'ToyMaze2DEnv-v0',
      'colorization__ColorizationEnv-v2',
      'match_equation__MatchEquation-v0',
      'FetchPickAndPlaceDiscrete-v4',
      'match_move__MatchRotation-v0',
      'mental_rotation-3d_objaverse-v0',
      'patch_reassembly__PatchReassemblyEnv-v0',
      'ref_dot__RefCOCOPlusDotEnv-v0',
      'zoom_in__ZoomInEnv-v0'
    ];

    // Environment metadata mapping
    const environmentMetadata = {
      'colorization__ColorizationEnv-v2': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'rotate(θ); saturate(δ); stop()'
      },
      'counting__LVISCountingEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'mark(x, y); undo(); guess(N); stop()'
      },
      'Jigsaw-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'swap((r1, c1), (r2, c2)); reorder([...]); stop()'
      },
      'match_equation__MatchEquation-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'move([i, s, j, t]); undo(); stop()'
      },
      'match_move__MatchRotation-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Unknown',
        p: '3',
        actions: 'move([dx, dy, dθ]); stop()'
      },
      'ToyMaze2DEnv-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'move(d); stop()'
      },
      'ToyMaze3DEnv-v0': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Known',
        p: '2',
        actions: 'move(0); turn(d); stop()'
      },
      'mental_rotation__mental_rotation-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'rotate(θ); stop()'
      },
      'mental_rotation_3d__mental_rotation-3d': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Known',
        p: '3',
        actions: 'rotate([dy, dp, dr]); stop()'
      },
      'mental_rotation-3d_objaverse-v0': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Known',
        p: '1',
        actions: 'rotate([dr, dp, dy]); stop()'
      },
      'FetchPickAndPlaceDiscrete-v4': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Unknown',
        p: '0',
        actions: 'move([x, y, z]); gripper(g); stop()'
      },
      'FetchReachDiscrete-v4': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Unknown',
        p: '0',
        actions: 'move([x, y, z]); stop()'
      },
      'patch_reassembly__PatchReassemblyEnv-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'place(p, r, c); remove(p); stop()'
      },
      'ref_dot__RefCOCOPlusDotEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '0',
        actions: 'mark(x, y); stop()'
      },
      'sliding_block__SlidingBlockEnv-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'move(b, d); stop()'
      },
      'video_unshuffle__VideoUnshuffleEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '3',
        actions: 'swap(i, j); reorder([...]); stop()'
      },
      'zoom_in__ZoomInEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '5',
        actions: 'swap(i, j); reorder([...]); stop()'
      }
    };

    let currentEnvironment = null;
    let currentStepIndex = 0;
    let traceData = [];
    let maxSteps = 0;
    let designContext = '';
    let isPlaying = false;
    let playInterval = null;
    const playIntervalDelay = 2000; // 2 seconds per step
    let isAutoCyclingEnvironments = false;
    let currentEnvironmentIndex = 0;
    let environmentCycleInterval = null;
    const environmentCycleDelay = 5000; // 5 seconds per environment (adjust based on steps)
    let stepCycleCount = 0;
    const maxCyclesPerEnvironment = 1; // Play each environment 1 full cycle before switching

    // Select environment from chip navigation
    function selectEnvironment(envName) {
      // Stop auto-cycling when user manually selects
      stopAutoCyclingEnvironments();
      loadEnvironment(envName);
    }

    // Start auto-cycling through all environments
    function startAutoCyclingEnvironments() {
      if (isAutoCyclingEnvironments || environments.length === 0) return;
      
      isAutoCyclingEnvironments = true;
      currentEnvironmentIndex = 0;
      
      // Immediately load first environment (will auto-start playing)
      if (environments.length > 0) {
        loadEnvironment(environments[0]);
      }
    }

    // Stop auto-cycling through environments
    function stopAutoCyclingEnvironments() {
      if (!isAutoCyclingEnvironments) return;
      
      isAutoCyclingEnvironments = false;
      if (environmentCycleInterval) {
        clearInterval(environmentCycleInterval);
        environmentCycleInterval = null;
      }
    }

    // Load environment data
    async function loadEnvironment(envName) {
      if (!envName) {
        resetDashboard();
        updateEnvironmentSelection(null);
        return;
      }
      
      // Update currentEnvironmentIndex to match the loaded environment
      const envIndex = environments.indexOf(envName);
      if (envIndex !== -1) {
        currentEnvironmentIndex = envIndex;
      }
      
      // Reset step cycle count when loading new environment
      stepCycleCount = 0;
      
      // Update chip selection
      updateEnvironmentSelection(envName);

      currentEnvironment = envName;
      currentStepIndex = -1; // Start at briefing state (-1 means briefing, 0 means stepId 1)
      traceData = [];
      
      // Reset opacity for fade in effect
      const dashboardContainer = document.getElementById('dashboardContainer');
      const missionDataContainer = document.getElementById('missionDataContainer');
      if (dashboardContainer) {
        dashboardContainer.style.opacity = '0';
        dashboardContainer.style.transition = 'opacity 0.5s ease-in';
      }
      if (missionDataContainer) {
        missionDataContainer.style.opacity = '0';
        missionDataContainer.style.transition = 'opacity 0.5s ease-in';
      }
      
      // Show loading state
      document.getElementById('stepIndicator').textContent = 'Loading environment...';
      document.getElementById('imagePlaceholder').innerHTML = '<div class="loading-spinner"></div>';
      document.getElementById('imagePlaceholder').style.display = 'block';
      document.getElementById('agentViewImage').style.display = 'none';
      document.getElementById('promptText').textContent = 'Loading...';
      document.getElementById('actionOutput').textContent = 'Loading...';
      const loadingText = highlightGoalContent('Loading environment data...');
      document.getElementById('designContext').innerHTML = loadingText + '<span class="goal-cursor">█</span>';
      
      // Show mission briefing container
      if (missionDataContainer) missionDataContainer.style.display = 'flex';

      try {
        // Update environment info
        updateEnvironmentInfo(envName);
        
        // Discover steps by trying to load files
        maxSteps = await discoverSteps(envName);
        
        if (maxSteps === 0) {
          throw new Error('No steps found for this environment');
        }

        // Load design context from prompt_0 (task goal/description)
        await loadDesignContext(envName);
        
        // Load all step data
        await loadAllSteps(envName, maxSteps);
        
        // Show briefing state (stepId === 0, which is currentStepIndex === -1)
        // Display briefing with mission data and goal
        updateDisplay();
        updateNavigationButtons();
        
        // Fade in effect after loading
        setTimeout(() => {
          if (dashboardContainer) {
            dashboardContainer.style.opacity = '1';
          }
          if (missionDataContainer) {
            missionDataContainer.style.opacity = '1';
          }
        }, 100);
        
        // Wait shorter time at briefing if auto-cycling (3 seconds), otherwise 8 seconds
        const briefingDelay = isAutoCyclingEnvironments ? 3000 : 8000;
        setTimeout(() => {
          if (currentEnvironment === envName) {
            currentStepIndex = 0; // Move to stepId === 1
            updateDisplay();
            updateNavigationButtons();
            startPlaying();
          }
        }, briefingDelay);
      } catch (error) {
        console.error('Error loading environment:', error);
        document.getElementById('imagePlaceholder').innerHTML = 
          `<div class="error-message">Error loading environment: ${error.message}</div>`;
        document.getElementById('promptText').textContent = 'Error loading data';
        document.getElementById('actionOutput').textContent = 'Error';
        const errorText = highlightGoalContent('Failed to load environment data.');
        document.getElementById('designContext').innerHTML = errorText + '<span class="goal-cursor">█</span>';
      }
    }

    // Discover number of steps by checking files
    async function discoverSteps(envName) {
      let maxStep = 0;
      // Try up to 100 steps
      for (let i = 0; i < 100; i++) {
        const imagePath = `static/appendix/${envName}/image_${i}.png`;
        try {
          const response = await fetch(imagePath, { method: 'HEAD' });
          if (response.ok) {
            maxStep = i + 1;
          } else {
            break;
          }
        } catch (e) {
          break;
        }
      }
      return maxStep;
    }

    // Load design context from prompt_0
    async function loadDesignContext(envName) {
      try {
        const response = await fetch(`static/appendix/${envName}/prompt_0.txt`);
        if (response.ok) {
          const promptText = await response.text();
          designContext = extractContextFromPrompt(promptText);
          // Update the design context display with highlighting
          const designContextElement = document.getElementById('designContext');
          const highlightedText = highlightGoalContent(designContext);
          designContextElement.innerHTML = highlightedText + '<span class="goal-cursor">█</span>';
          // Debug: log the full text to console
          console.log('Full design context loaded:', designContext.length, 'characters');
        } else {
          designContext = 'No context available';
          const highlightedText = highlightGoalContent(designContext);
          document.getElementById('designContext').innerHTML = highlightedText + '<span class="goal-cursor">█</span>';
        }
      } catch (error) {
        console.warn('Error loading design context:', error);
        designContext = 'Failed to load context';
        const highlightedText = highlightGoalContent(designContext);
        document.getElementById('designContext').innerHTML = highlightedText + '<span class="goal-cursor">█</span>';
      }
    }
    
    // Highlight important content in Goal section
    function highlightGoalContent(text) {
      if (!text) return text;
      
      // Escape HTML to prevent XSS
      let highlighted = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      // Highlight dimensions and numbers (e.g., 9x9, 3D, 102) - Yellow background
      highlighted = highlighted.replace(/(\d+x\d+|\d+\s*x\s*\d+|\d+D|\d+)/g, '<span class="highlight-yellow">$1</span>');
      
      // Highlight colors (RED, BLUE, GREEN, etc.) - Yellow background
      highlighted = highlighted.replace(/\b(RED|BLUE|GREEN|YELLOW|BLACK|WHITE|ORANGE|PURPLE|CYAN|MAGENTA)\b/gi, '<span class="highlight-yellow">$1</span>');
      
      // Highlight key objects and concepts - Blue background
      highlighted = highlighted.replace(/\b(TARGET|GOAL|OBJECTIVE|SPHERE|CUBE|MAZE|BLOCK|PATCH|DOT|POINT|GRID|WALL|CORNER|EDGE|CENTER)\b/gi, '<span class="highlight-blue">$1</span>');
      
      // Highlight action functions - Code style (purple)
      const actionFunctions = ['move', 'turn', 'stop', 'mark', 'rotate', 'swap', 'place', 'remove', 'saturate', 'undo', 'guess', 'reorder', 'gripper'];
      actionFunctions.forEach(func => {
        const regex = new RegExp(`\\b(${func})\\s*\\([^)]*\\)`, 'gi');
        highlighted = highlighted.replace(regex, '<span class="highlight-code">$&</span>');
      });
      
      // Highlight action function names without parentheses - Code style
      actionFunctions.forEach(func => {
        const regex = new RegExp(`\\b(${func})\\b(?![(])`, 'gi');
        highlighted = highlighted.replace(regex, '<span class="highlight-code">$1</span>');
      });
      
      // Highlight important keywords - Red background
      highlighted = highlighted.replace(/\b(SUCCESS|FAILURE|ERROR|WARNING|IMPORTANT|NOTE|CONSTRAINT|LIMIT|MUST|CANNOT|AVOID)\b/gi, '<span class="highlight-red">$1</span>');
      
      // Highlight coordinates and positions - Yellow background
      highlighted = highlighted.replace(/(\([^)]*\d+[^)]*\)|\[[^\]]*\d+[^\]]*\])/g, '<span class="highlight-yellow">$1</span>');
      
      return highlighted;
    }

    // Load all steps data
    async function loadAllSteps(envName, maxSteps) {
      traceData = [];
      
      for (let i = 0; i < maxSteps; i++) {
        try {
          const [promptText, actionText] = await Promise.all([
            fetch(`static/appendix/${envName}/prompt_${i}.txt`).then(r => r.ok ? r.text() : ''),
            fetch(`static/appendix/${envName}/action_${i}.txt`).then(r => r.ok ? r.text() : '')
          ]);

          traceData.push({
            stepId: i + 1,
            imageUrl: `static/appendix/${envName}/image_${i}.png`,
            promptText: promptText.trim() || 'No prompt available',
            actionOutput: actionText.trim() || '-'
          });
        } catch (error) {
          console.warn(`Error loading step ${i}:`, error);
        }
      }
    }

    // Extract context/goal from prompt (return full text)
    function extractContextFromPrompt(promptText) {
      if (!promptText) return 'No context available';
      // Return the complete prompt text
      return promptText.trim();
    }

    // Update environment info display with Mission Data Card style
    function updateEnvironmentInfo(envName) {
      // Helper function to calculate bar width based on value
      function getBarWidth(value, type) {
        if (!value || value === '-') return 0;
        
        // Map text values to percentages for visual bars
        const valueMaps = {
          domain: { 'Real': 60, 'Synthetic': 40 },
          obs: { 'Full': 100, 'Partial': 50 },
          dyn: { 'Known': 100, 'Unknown': 30 },
          p: (val) => Math.min(parseInt(val) * 15, 100) // Parameters: scale by value
        };
        
        if (type === 'p') {
          return valueMaps.p(value);
        }
        
        const map = valueMaps[type];
        return map[value] || 50;
      }
      
      if (!envName) {
        document.getElementById('infoDomain').textContent = '-';
        document.getElementById('infoObs').textContent = '-';
        document.getElementById('infoDyn').textContent = '-';
        document.getElementById('infoP').textContent = '-';
        
        // Reset bars
        document.getElementById('statDomainBar').style.width = '0%';
        document.getElementById('statObsBar').style.width = '0%';
        document.getElementById('statDynBar').style.width = '0%';
        document.getElementById('statPBar').style.width = '0%';
        return;
      }
      
      const metadata = environmentMetadata[envName];
      if (metadata) {
        // Update text values
        document.getElementById('infoDomain').textContent = metadata.domain;
        document.getElementById('infoObs').textContent = metadata.obs;
        document.getElementById('infoDyn').textContent = metadata.dyn;
        document.getElementById('infoP').textContent = metadata.p;
        
        // Update bar widths with animation
        setTimeout(() => {
          document.getElementById('statDomainBar').style.width = getBarWidth(metadata.domain, 'domain') + '%';
          document.getElementById('statObsBar').style.width = getBarWidth(metadata.obs, 'obs') + '%';
          document.getElementById('statDynBar').style.width = getBarWidth(metadata.dyn, 'dyn') + '%';
          document.getElementById('statPBar').style.width = getBarWidth(metadata.p, 'p') + '%';
        }, 100);
      } else {
        document.getElementById('infoDomain').textContent = '-';
        document.getElementById('infoObs').textContent = '-';
        document.getElementById('infoDyn').textContent = '-';
        document.getElementById('infoP').textContent = '-';
        
        // Reset bars
        document.getElementById('statDomainBar').style.width = '0%';
        document.getElementById('statObsBar').style.width = '0%';
        document.getElementById('statDynBar').style.width = '0%';
        document.getElementById('statPBar').style.width = '0%';
      }
    }

    // Update all display elements
    function updateDisplay() {
      const missionDataContainer = document.getElementById('missionDataContainer');
      const dashboardContainer = document.getElementById('dashboardContainer');
      
      // Handle briefing state (currentStepIndex === -1)
      if (currentStepIndex === -1) {
        // Show mission briefing
        if (missionDataContainer) missionDataContainer.style.display = 'flex';
        // Hide dashboard content (image and monitors) during briefing
        if (dashboardContainer) dashboardContainer.style.display = 'none';
        document.getElementById('stepIndicator').textContent = 'Mission Briefing';
        document.getElementById('progressFill').style.width = '0%';
        
        // Hide feedback and action monitors during briefing
        const feedbackMonitor = document.getElementById('feedbackMonitor');
        const consoleCable = document.getElementById('consoleCable');
        if (feedbackMonitor) feedbackMonitor.style.display = 'none';
        if (consoleCable) consoleCable.style.display = 'none';
        return;
      }
      
      // Show dashboard content when not in briefing
      if (dashboardContainer) {
        dashboardContainer.style.display = 'flex';
        // Ensure opacity is set for smooth transition
        if (!dashboardContainer.style.opacity) {
          dashboardContainer.style.opacity = '1';
        }
      }
      
      // Hide mission briefing when stepId >= 1
      if (missionDataContainer) {
        missionDataContainer.style.display = 'none';
      }
      
      if (traceData.length === 0 || currentStepIndex >= traceData.length || currentStepIndex < 0) {
        return;
      }

      const currentData = traceData[currentStepIndex];
      
      // Update step indicator
      document.getElementById('stepIndicator').textContent = 
        `Step ${currentData.stepId} of ${traceData.length}`;
      
      // Update progress bar
      const progressPercentage = (currentData.stepId / traceData.length) * 100;
      document.getElementById('progressFill').style.width = progressPercentage + '%';
      
      // Update image smoothly without flickering
      const imageElement = document.getElementById('agentViewImage');
      const placeholderElement = document.getElementById('imagePlaceholder');
      
      // Preload image before switching
      const newImage = new Image();
      newImage.onload = function() {
        imageElement.src = currentData.imageUrl;
        imageElement.style.display = 'block';
        placeholderElement.style.display = 'none';
      };
      newImage.src = currentData.imageUrl;
      
      // Handle image load error
      imageElement.onerror = function() {
        imageElement.style.display = 'none';
        placeholderElement.textContent = 'Image not available';
        placeholderElement.style.display = 'block';
      };
      
      // Update prompt text (design context stays the same, loaded from prompt_0)
      // Don't show feedback monitor for step 0 (stepId === 1)
      const feedbackMonitor = document.getElementById('feedbackMonitor');
      const consoleCable = document.getElementById('consoleCable');
      const promptTextElement = document.getElementById('promptText');
      const actionOutputElement = document.getElementById('actionOutput');
      
      if (currentData.stepId === 1) {
        if (feedbackMonitor) {
          feedbackMonitor.style.opacity = '0';
          setTimeout(() => {
            feedbackMonitor.style.display = 'none';
          }, 300);
        }
        if (consoleCable) {
          consoleCable.style.opacity = '0';
          setTimeout(() => {
            consoleCable.style.display = 'none';
          }, 300);
        }
      } else {
        if (feedbackMonitor && feedbackMonitor.style.display === 'none') {
          feedbackMonitor.style.display = 'block';
          feedbackMonitor.style.opacity = '0';
          setTimeout(() => {
            feedbackMonitor.style.opacity = '1';
          }, 50);
        }
        if (consoleCable && consoleCable.style.display === 'none') {
          consoleCable.style.display = 'block';
          consoleCable.style.opacity = '0';
          setTimeout(() => {
            consoleCable.style.opacity = '1';
          }, 50);
        }
        
        // Fade animation for text updates
        promptTextElement.style.opacity = '0';
        setTimeout(() => {
          promptTextElement.textContent = currentData.promptText;
          promptTextElement.style.opacity = '1';
        }, 150);
      }
      
      // Update action output with fade animation
      actionOutputElement.style.opacity = '0';
      setTimeout(() => {
        actionOutputElement.textContent = currentData.actionOutput;
        actionOutputElement.style.opacity = '1';
      }, 150);
    }

    // Update navigation button states
    function updateNavigationButtons() {
      const isBriefing = currentStepIndex === -1;
      const isFirst = currentStepIndex === 0;
      const isLast = currentStepIndex >= traceData.length - 1;
      
      // During briefing, disable prev/first buttons, enable next/last
      if (isBriefing) {
        document.getElementById('firstButton').disabled = true;
        document.getElementById('prevButton').disabled = true;
        document.getElementById('nextButton').disabled = traceData.length === 0;
        document.getElementById('lastButton').disabled = traceData.length === 0;
      } else {
        // At first step, prev button should go back to briefing
        document.getElementById('firstButton').disabled = traceData.length === 0;
        document.getElementById('prevButton').disabled = traceData.length === 0; // Can go back to briefing
        document.getElementById('nextButton').disabled = isLast || traceData.length === 0;
        document.getElementById('lastButton').disabled = isLast || traceData.length === 0;
      }
    }

    // Navigate between steps
    function navigateStep(direction) {
      if (traceData.length === 0) return;
      
      // Handle briefing state navigation (briefing can auto-play, don't pause here)
      if (currentStepIndex === -1) {
        if (direction > 0) {
          // Move from briefing to first step
          // If manually navigating away from briefing while playing, pause
          if (isPlaying) {
            stopPlaying();
          }
          currentStepIndex = 0;
          updateDisplay();
          updateNavigationButtons();
        }
        return;
      }
      
      // If manually navigating while playing (non-briefing pages), pause
      if (isPlaying) {
        stopPlaying();
      }
      
      // Allow going back to briefing from first step
      if (currentStepIndex === 0 && direction < 0) {
        // If manually navigating back to briefing while playing, pause
        if (isPlaying) {
          stopPlaying();
        }
        currentStepIndex = -1;
        updateDisplay();
        updateNavigationButtons();
        // When going back to briefing, restart auto-play after 8 seconds
        setTimeout(() => {
          if (currentStepIndex === -1 && currentEnvironment && !isPlaying) {
            currentStepIndex = 0;
            updateDisplay();
            updateNavigationButtons();
            startPlaying();
          }
        }, 8000);
        return;
      }
      
      const newIndex = currentStepIndex + direction;
      
      if (newIndex >= 0 && newIndex < traceData.length) {
        currentStepIndex = newIndex;
        updateDisplay();
        updateNavigationButtons();
      }
    }

    // Navigate to first or last step
    // isAutoPlay: true if called from auto-play loop, false if manual
    function navigateToStep(target, isAutoPlay = false) {
      if (traceData.length === 0) return;
      
      let newIndex;
      if (target === 0) {
        // Go to briefing (first state)
        newIndex = -1;
        // If manually navigating to briefing while playing, pause
        if (isPlaying && !isAutoPlay) {
          stopPlaying();
        }
        // When going to briefing, restart auto-play after 8 seconds (only if not already playing)
        setTimeout(() => {
          if (currentStepIndex === -1 && currentEnvironment && !isPlaying) {
            currentStepIndex = 0;
            updateDisplay();
            updateNavigationButtons();
            startPlaying();
          }
        }, 8000);
      } else if (target === -1) {
        // Go to last step
        // If manually navigating while playing (non-briefing), pause
        if (isPlaying && !isAutoPlay) {
          stopPlaying();
        }
        newIndex = traceData.length - 1;
      } else {
        return;
      }
      
      currentStepIndex = newIndex;
      updateDisplay();
      updateNavigationButtons();
    }

    // Start auto-playing
    function startPlaying() {
      if (isPlaying || traceData.length === 0) return;
      
      isPlaying = true;
      updatePlayPauseButton();
      
      // Reset cycle count when starting to play
      stepCycleCount = 0;
      
      playInterval = setInterval(() => {
        // If at briefing state, move to first step
        if (currentStepIndex === -1) {
          currentStepIndex = 0;
          updateDisplay();
          updateNavigationButtons();
          return;
        }
        
        if (currentStepIndex < traceData.length - 1) {
          // Auto-play: navigate to next step without pausing
          currentStepIndex++;
          updateDisplay();
          updateNavigationButtons();
        } else {
          // Reached the last step - switch to next environment if auto-cycling
          if (isAutoCyclingEnvironments) {
            // Stop current playback
            stopPlaying();
            // Add fade out effect before switching
            const dashboardContainer = document.getElementById('dashboardContainer');
            const missionDataContainer = document.getElementById('missionDataContainer');
            
            if (dashboardContainer) {
              dashboardContainer.style.opacity = '0';
              dashboardContainer.style.transition = 'opacity 0.5s ease-out';
            }
            if (missionDataContainer) {
              missionDataContainer.style.opacity = '0';
              missionDataContainer.style.transition = 'opacity 0.5s ease-out';
            }
            
            // Wait for fade out, then switch to next environment
            setTimeout(() => {
              if (isAutoCyclingEnvironments && currentEnvironment) {
                currentEnvironmentIndex = (currentEnvironmentIndex + 1) % environments.length;
                loadEnvironment(environments[currentEnvironmentIndex]);
              }
            }, 500); // Wait for fade out animation
          } else {
            // If not auto-cycling, loop back to briefing
            currentStepIndex = -1;
            stepCycleCount++;
            updateDisplay();
            updateNavigationButtons();
          }
        }
      }, playIntervalDelay);
    }

    // Stop auto-playing
    function stopPlaying() {
      if (!isPlaying) return;
      
      isPlaying = false;
      if (playInterval) {
        clearInterval(playInterval);
        playInterval = null;
      }
      updatePlayPauseButton();
    }

    // Toggle play/pause
    function togglePlayPause() {
      if (traceData.length === 0) return;
      
      if (isPlaying) {
        stopPlaying();
      } else {
        startPlaying();
      }
    }

    // Update play/pause button appearance
    function updatePlayPauseButton() {
      const icon = document.getElementById('playPauseIcon');
      
      if (isPlaying) {
        icon.textContent = '⏸';
      } else {
        icon.textContent = '▶';
      }
    }

    // Reset dashboard
    function resetDashboard() {
      stopPlaying();
      traceData = [];
      currentStepIndex = -1; // Reset to briefing state
      designContext = '';
      document.getElementById('stepIndicator').textContent = 'Select an environment to start';
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('imagePlaceholder').textContent = 'No environment selected';
      document.getElementById('imagePlaceholder').style.display = 'block';
      document.getElementById('agentViewImage').style.display = 'none';
      document.getElementById('promptText').textContent = 'Waiting for environment selection...';
      document.getElementById('actionOutput').textContent = '-';
      const defaultText = highlightGoalContent('Select an environment to view the task context and goal.');
      document.getElementById('designContext').innerHTML = defaultText + '<span class="goal-cursor">█</span>';
      const feedbackMonitor = document.getElementById('feedbackMonitor');
      const consoleCable = document.getElementById('consoleCable');
      const missionDataContainer = document.getElementById('missionDataContainer');
      const dashboardContainer = document.getElementById('dashboardContainer');
      if (feedbackMonitor) feedbackMonitor.style.display = 'block';
      if (consoleCable) consoleCable.style.display = 'block';
      if (missionDataContainer) missionDataContainer.style.display = 'flex';
      if (dashboardContainer) dashboardContainer.style.display = 'none'; // Hide dashboard when no environment
      updateEnvironmentInfo(null);
      updateNavigationButtons();
      updatePlayPauseButton();
      updateEnvironmentSelection(null);
    }

    // Keyboard navigation support
    document.addEventListener('keydown', function(event) {
      // Prevent navigation if user is typing in an input field
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return;
      }
      
      if (event.key === 'ArrowLeft') {
        event.preventDefault();
        navigateStep(-1);
      } else if (event.key === 'ArrowRight') {
        event.preventDefault();
        navigateStep(1);
      }
    });

    // Update environment card selection
    function updateEnvironmentSelection(envName) {
      const cards = document.querySelectorAll('.environment-card');
      cards.forEach(card => {
        if (card.getAttribute('data-env') === envName) {
          card.classList.add('active');
        } else {
          card.classList.remove('active');
        }
      });
    }

    // Initialize auto-scrolling environment cards
    function initEnvironmentCardsScroll() {
      const wrapper = document.getElementById('environmentCardsWrapper');
      const duplicateWrapper = document.getElementById('environmentCardsWrapperDuplicate');
      
      if (!wrapper || !duplicateWrapper) return;
      
      // Clone all cards to duplicate wrapper for seamless loop
      const cards = wrapper.querySelectorAll('.environment-card');
      cards.forEach(card => {
        const clonedCard = card.cloneNode(true);
        // Re-attach click handlers
        const envName = clonedCard.getAttribute('data-env');
        if (envName) {
          clonedCard.onclick = () => selectEnvironment(envName);
        }
        duplicateWrapper.appendChild(clonedCard);
      });
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
      // Initialize auto-scrolling cards
      initEnvironmentCardsScroll();
      // Start auto-cycling through all environments immediately
      startAutoCyclingEnvironments();
    });
    
    // Also try to start immediately if DOM is already loaded
    if (document.readyState !== 'loading') {
      initEnvironmentCardsScroll();
      startAutoCyclingEnvironments();
    }
  </script>

  <script>
    // No marquee duplication needed; mobile grid shows all envs
  </script>
</body>
</html>
