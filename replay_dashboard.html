<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent Replay Dashboard</title>
  <link rel="stylesheet" href="static/css/replay_dashboard.css">
</head>
<body>
  <div class="dashboard-header">
    <div class="header-title">AI Agent Replay Dashboard</div>
  </div>
  
  <div class="environment-nav-container">
    <div class="environment-nav-scroll" id="environmentNavScroll">
      <div class="environment-card" data-env="ToyMaze3DEnv-v0" onclick="selectEnvironment('ToyMaze3DEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/ToyMaze3DEnv-v0/image_0.png" alt="ToyMaze3D" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EToyMaze3D%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">ToyMaze3D</div>
      </div>
      <div class="environment-card" data-env="sliding_block__SlidingBlockEnv-v0" onclick="selectEnvironment('sliding_block__SlidingBlockEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/sliding_block__SlidingBlockEnv-v0/image_0.png" alt="SlidingBlock" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ESlidingBlock%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">SlidingBlock</div>
      </div>
      <div class="environment-card" data-env="video_unshuffle__VideoUnshuffleEnv-v0" onclick="selectEnvironment('video_unshuffle__VideoUnshuffleEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/video_unshuffle__VideoUnshuffleEnv-v0/image_0.png" alt="VideoUnshuffle" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EVideoUnshuffle%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">VideoUnshuffle</div>
      </div>
      <div class="environment-card" data-env="FetchReachDiscrete-v4" onclick="selectEnvironment('FetchReachDiscrete-v4')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/FetchReachDiscrete-v4/image_0.png" alt="FetchReach" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EFetchReach%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">FetchReach</div>
      </div>
      <div class="environment-card" data-env="counting__LVISCountingEnv-v0" onclick="selectEnvironment('counting__LVISCountingEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/counting__LVISCountingEnv-v0/image_0.png" alt="LVISCounting" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ELVISCounting%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">LVISCounting</div>
      </div>
      <div class="environment-card" data-env="mental_rotation_3d__mental_rotation-3d" onclick="selectEnvironment('mental_rotation_3d__mental_rotation-3d')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/mental_rotation_3d__mental_rotation-3d/image_0.png" alt="Mental Rotation 3D" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMental 3D%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Mental Rotation 3D</div>
      </div>
      <div class="environment-card" data-env="mental_rotation__mental_rotation-v0" onclick="selectEnvironment('mental_rotation__mental_rotation-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/mental_rotation__mental_rotation-v0/image_0.png" alt="Mental Rotation" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMental Rotation%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Mental Rotation</div>
      </div>
      <div class="environment-card" data-env="Jigsaw-v0" onclick="selectEnvironment('Jigsaw-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/Jigsaw-v0/image_0.png" alt="Jigsaw" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EJigsaw%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Jigsaw</div>
      </div>
      <div class="environment-card" data-env="ToyMaze2DEnv-v0" onclick="selectEnvironment('ToyMaze2DEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/ToyMaze2DEnv-v0/image_0.png" alt="ToyMaze2D" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EToyMaze2D%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">ToyMaze2D</div>
      </div>
      <div class="environment-card" data-env="colorization__ColorizationEnv-v2" onclick="selectEnvironment('colorization__ColorizationEnv-v2')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/colorization__ColorizationEnv-v2/image_0.png" alt="Colorization" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EColorization%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Colorization</div>
      </div>
      <div class="environment-card" data-env="match_equation__MatchEquation-v0" onclick="selectEnvironment('match_equation__MatchEquation-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/match_equation__MatchEquation-v0/image_0.png" alt="MatchEquation" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMatchEquation%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">MatchEquation</div>
      </div>
      <div class="environment-card" data-env="FetchPickAndPlaceDiscrete-v4" onclick="selectEnvironment('FetchPickAndPlaceDiscrete-v4')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/FetchPickAndPlaceDiscrete-v4/image_0.png" alt="FetchPickPlace" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EFetchPickPlace%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">FetchPickPlace</div>
      </div>
      <div class="environment-card" data-env="match_move__MatchRotation-v0" onclick="selectEnvironment('match_move__MatchRotation-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/match_move__MatchRotation-v0/image_0.png" alt="MatchRotation" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMatchRotation%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">MatchRotation</div>
      </div>
      <div class="environment-card" data-env="mental_rotation-3d_objaverse-v0" onclick="selectEnvironment('mental_rotation-3d_objaverse-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/mental_rotation-3d_objaverse-v0/image_0.png" alt="Mental 3D Objaverse" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EMental 3D Objaverse%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">Mental 3D Objaverse</div>
      </div>
      <div class="environment-card" data-env="patch_reassembly__PatchReassemblyEnv-v0" onclick="selectEnvironment('patch_reassembly__PatchReassemblyEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/patch_reassembly__PatchReassemblyEnv-v0/image_0.png" alt="PatchReassembly" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EPatchReassembly%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">PatchReassembly</div>
      </div>
      <div class="environment-card" data-env="ref_dot__RefCOCOPlusDotEnv-v0" onclick="selectEnvironment('ref_dot__RefCOCOPlusDotEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/ref_dot__RefCOCOPlusDotEnv-v0/image_0.png" alt="RefCOCOPlus" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ERefCOCOPlus%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">RefCOCOPlus</div>
      </div>
      <div class="environment-card" data-env="stringsight" onclick="selectEnvironment('stringsight')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/stringsight/image_0.png" alt="StringSight" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EStringSight%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">StringSight</div>
      </div>
      <div class="environment-card" data-env="zoom_in__ZoomInEnv-v0" onclick="selectEnvironment('zoom_in__ZoomInEnv-v0')">
        <div class="card-image-wrapper">
          <img class="card-image" src="static/appendix/zoom_in__ZoomInEnv-v0/image_0.png" alt="ZoomIn" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2260%22%3E%3Crect fill=%22%23e0e0e0%22 width=%22100%22 height=%2260%22/%3E%3Ctext x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3EZoomIn%3C/text%3E%3C/svg%3E'" />
          <div class="card-status-bar"></div>
        </div>
        <div class="card-label">ZoomIn</div>
      </div>
    </div>
  </div>
  
  <div class="dashboard-container">
    <!-- Left Panel: Visuals -->
    <div class="left-panel">
      <div class="image-container">
        <div id="imagePlaceholder" class="image-placeholder">No environment selected</div>
        <img id="agentViewImage" class="agent-view-image" style="display: none;" alt="Agent View" />
      </div>
    </div>

    <!-- Right Panel: Data & Logic -->
    <div class="right-panel">
      <!-- Card 0: Environment Info -->
      <div class="info-card" id="environmentInfoCard">
        <div class="card-title">Environment Info</div>
        <div class="card-content">
          <div class="environment-info-table" id="environmentInfo">
            <div class="info-row">
              <span class="info-label">Domain:</span>
              <span class="info-value" id="infoDomain">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Observability (Obs.):</span>
              <span class="info-value" id="infoObs">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Dynamics (Dyn.):</span>
              <span class="info-value" id="infoDyn">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Parameters (P.):</span>
              <span class="info-value" id="infoP">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Available Actions:</span>
              <span class="info-value" id="infoActions">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Card 1: Goal -->
      <div class="info-card">
        <div class="card-title">Goal</div>
        <div class="card-content design-context" id="designContext">
          Select an environment to view the task context and goal.
        </div>
      </div>

      <!-- Card 2: Feedback -->
      <div class="info-card" id="feedbackCard">
        <div class="card-title">Feedback</div>
        <div class="card-content">
          <pre class="prompt-text" id="promptText">Waiting for environment selection...</pre>
        </div>
      </div>

      <!-- Card 3: Action -->
      <div class="info-card">
        <div class="card-title">Action</div>
        <div class="card-content">
          <div class="action-output" id="actionOutput">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Player Controls -->
  <div class="bottom-player-controls">
    <div class="player-controls-container">
      <div class="player-progress-section">
        <div class="step-indicator" id="stepIndicator">Select an environment to start</div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>
      
      <div class="player-buttons-group">
        <button class="player-nav-button" id="firstButton" onclick="navigateToStep(0)" disabled>
          <span class="player-button-icon">⏮</span>
        </button>
        <button class="player-nav-button" id="prevButton" onclick="navigateStep(-1)" disabled>
          <span class="player-button-icon">◀</span>
        </button>
        <button class="player-nav-button player-play-button" id="playPauseButton" onclick="togglePlayPause()">
          <span class="player-button-icon" id="playPauseIcon">⏸</span>
        </button>
        <button class="player-nav-button" id="nextButton" onclick="navigateStep(1)" disabled>
          <span class="player-button-icon">▶</span>
        </button>
        <button class="player-nav-button" id="lastButton" onclick="navigateToStep(-1)" disabled>
          <span class="player-button-icon">⏭</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Available environments
    const environments = [
      'ToyMaze3DEnv-v0',
      'sliding_block__SlidingBlockEnv-v0',
      'video_unshuffle__VideoUnshuffleEnv-v0',
      'FetchReachDiscrete-v4',
      'counting__LVISCountingEnv-v0',
      'mental_rotation_3d__mental_rotation-3d',
      'mental_rotation__mental_rotation-v0',
      'Jigsaw-v0',
      'ToyMaze2DEnv-v0',
      'colorization__ColorizationEnv-v2',
      'match_equation__MatchEquation-v0',
      'FetchPickAndPlaceDiscrete-v4',
      'match_move__MatchRotation-v0',
      'mental_rotation-3d_objaverse-v0',
      'patch_reassembly__PatchReassemblyEnv-v0',
      'ref_dot__RefCOCOPlusDotEnv-v0',
      'stringsight',
      'zoom_in__ZoomInEnv-v0'
    ];

    // Environment metadata mapping
    const environmentMetadata = {
      'colorization__ColorizationEnv-v2': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'rotate(θ); saturate(δ); stop()'
      },
      'counting__LVISCountingEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'mark(x, y); undo(); guess(N); stop()'
      },
      'Jigsaw-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'swap((r1, c1), (r2, c2)); reorder([...]); stop()'
      },
      'match_equation__MatchEquation-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'move([i, s, j, t]); undo(); stop()'
      },
      'match_move__MatchRotation-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Unknown',
        p: '3',
        actions: 'move([dx, dy, dθ]); stop()'
      },
      'ToyMaze2DEnv-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'move(d); stop()'
      },
      'ToyMaze3DEnv-v0': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Known',
        p: '2',
        actions: 'move(0); turn(d); stop()'
      },
      'mental_rotation__mental_rotation-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'rotate(θ); stop()'
      },
      'mental_rotation_3d__mental_rotation-3d': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Known',
        p: '3',
        actions: 'rotate([dy, dp, dr]); stop()'
      },
      'mental_rotation-3d_objaverse-v0': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Known',
        p: '1',
        actions: 'rotate([dr, dp, dy]); stop()'
      },
      'FetchPickAndPlaceDiscrete-v4': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Unknown',
        p: '0',
        actions: 'move([x, y, z]); gripper(g); stop()'
      },
      'FetchReachDiscrete-v4': {
        domain: 'Synthetic',
        obs: 'Partial',
        dyn: 'Unknown',
        p: '0',
        actions: 'move([x, y, z]); stop()'
      },
      'patch_reassembly__PatchReassemblyEnv-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '2',
        actions: 'place(p, r, c); remove(p); stop()'
      },
      'ref_dot__RefCOCOPlusDotEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '0',
        actions: 'mark(x, y); stop()'
      },
      'sliding_block__SlidingBlockEnv-v0': {
        domain: 'Synthetic',
        obs: 'Full',
        dyn: 'Known',
        p: '1',
        actions: 'move(b, d); stop()'
      },
      'video_unshuffle__VideoUnshuffleEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '3',
        actions: 'swap(i, j); reorder([...]); stop()'
      },
      'zoom_in__ZoomInEnv-v0': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '5',
        actions: 'swap(i, j); reorder([...]); stop()'
      },
      'stringsight': {
        domain: 'Real',
        obs: 'Full',
        dyn: 'Known',
        p: '6',
        actions: 'swap(i, j); reorder([...]); stop()'
      }
    };

    let currentEnvironment = null;
    let currentStepIndex = 0;
    let traceData = [];
    let maxSteps = 0;
    let designContext = '';
    let isPlaying = false;
    let playInterval = null;
    const playIntervalDelay = 2000; // 2 seconds per step
    let isAutoCyclingEnvironments = false;
    let currentEnvironmentIndex = 0;
    let environmentCycleInterval = null;
    const environmentCycleDelay = 5000; // 5 seconds per environment (adjust based on steps)
    let stepCycleCount = 0;
    const maxCyclesPerEnvironment = 1; // Play each environment 1 full cycle before switching

    // Select environment from chip navigation
    function selectEnvironment(envName) {
      // Stop auto-cycling when user manually selects
      stopAutoCyclingEnvironments();
      loadEnvironment(envName);
    }

    // Start auto-cycling through all environments
    function startAutoCyclingEnvironments() {
      if (isAutoCyclingEnvironments || environments.length === 0) return;
      
      isAutoCyclingEnvironments = true;
      currentEnvironmentIndex = 0;
      
      // Immediately load first environment (will auto-start playing)
      if (environments.length > 0) {
        loadEnvironment(environments[0]);
      }
    }

    // Stop auto-cycling through environments
    function stopAutoCyclingEnvironments() {
      if (!isAutoCyclingEnvironments) return;
      
      isAutoCyclingEnvironments = false;
      if (environmentCycleInterval) {
        clearInterval(environmentCycleInterval);
        environmentCycleInterval = null;
      }
    }

    // Load environment data
    async function loadEnvironment(envName) {
      if (!envName) {
        resetDashboard();
        updateEnvironmentSelection(null);
        return;
      }
      
      // Reset step cycle count when loading new environment
      stepCycleCount = 0;
      
      // Update chip selection
      updateEnvironmentSelection(envName);

      currentEnvironment = envName;
      currentStepIndex = 0;
      traceData = [];
      
      // Show loading state
      document.getElementById('stepIndicator').textContent = 'Loading environment...';
      document.getElementById('imagePlaceholder').innerHTML = '<div class="loading-spinner"></div>';
      document.getElementById('imagePlaceholder').style.display = 'block';
      document.getElementById('agentViewImage').style.display = 'none';
      document.getElementById('promptText').textContent = 'Loading...';
      document.getElementById('actionOutput').textContent = 'Loading...';
      document.getElementById('designContext').textContent = 'Loading environment data...';

      try {
        // Update environment info
        updateEnvironmentInfo(envName);
        
        // Discover steps by trying to load files
        maxSteps = await discoverSteps(envName);
        
        if (maxSteps === 0) {
          throw new Error('No steps found for this environment');
        }

        // Load design context from prompt_0 (task goal/description)
        await loadDesignContext(envName);
        
        // Load all step data
        await loadAllSteps(envName, maxSteps);
        
        // Update display
        updateDisplay();
        updateNavigationButtons();
        
        // Auto-start playing
        startPlaying();
      } catch (error) {
        console.error('Error loading environment:', error);
        document.getElementById('imagePlaceholder').innerHTML = 
          `<div class="error-message">Error loading environment: ${error.message}</div>`;
        document.getElementById('promptText').textContent = 'Error loading data';
        document.getElementById('actionOutput').textContent = 'Error';
        document.getElementById('designContext').textContent = 'Failed to load environment data.';
      }
    }

    // Discover number of steps by checking files
    async function discoverSteps(envName) {
      let maxStep = 0;
      // Try up to 100 steps
      for (let i = 0; i < 100; i++) {
        const imagePath = `static/appendix/${envName}/image_${i}.png`;
        try {
          const response = await fetch(imagePath, { method: 'HEAD' });
          if (response.ok) {
            maxStep = i + 1;
          } else {
            break;
          }
        } catch (e) {
          break;
        }
      }
      return maxStep;
    }

    // Load design context from prompt_0
    async function loadDesignContext(envName) {
      try {
        const response = await fetch(`static/appendix/${envName}/prompt_0.txt`);
        if (response.ok) {
          const promptText = await response.text();
          designContext = extractContextFromPrompt(promptText);
          // Update the design context display - use innerHTML to preserve formatting
          const designContextElement = document.getElementById('designContext');
          designContextElement.textContent = designContext;
          // Debug: log the full text to console
          console.log('Full design context loaded:', designContext.length, 'characters');
        } else {
          designContext = 'No context available';
          document.getElementById('designContext').textContent = designContext;
        }
      } catch (error) {
        console.warn('Error loading design context:', error);
        designContext = 'Failed to load context';
        document.getElementById('designContext').textContent = designContext;
      }
    }

    // Load all steps data
    async function loadAllSteps(envName, maxSteps) {
      traceData = [];
      
      for (let i = 0; i < maxSteps; i++) {
        try {
          const [promptText, actionText] = await Promise.all([
            fetch(`static/appendix/${envName}/prompt_${i}.txt`).then(r => r.ok ? r.text() : ''),
            fetch(`static/appendix/${envName}/action_${i}.txt`).then(r => r.ok ? r.text() : '')
          ]);

          traceData.push({
            stepId: i + 1,
            imageUrl: `static/appendix/${envName}/image_${i}.png`,
            promptText: promptText.trim() || 'No prompt available',
            actionOutput: actionText.trim() || '-'
          });
        } catch (error) {
          console.warn(`Error loading step ${i}:`, error);
        }
      }
    }

    // Extract context/goal from prompt (return full text)
    function extractContextFromPrompt(promptText) {
      if (!promptText) return 'No context available';
      // Return the complete prompt text
      return promptText.trim();
    }

    // Update environment info display
    function updateEnvironmentInfo(envName) {
      if (!envName) {
        document.getElementById('infoDomain').textContent = '-';
        document.getElementById('infoObs').textContent = '-';
        document.getElementById('infoDyn').textContent = '-';
        document.getElementById('infoP').textContent = '-';
        document.getElementById('infoActions').textContent = '-';
        return;
      }
      
      const metadata = environmentMetadata[envName];
      if (metadata) {
        document.getElementById('infoDomain').textContent = metadata.domain;
        document.getElementById('infoObs').textContent = metadata.obs;
        document.getElementById('infoDyn').textContent = metadata.dyn;
        document.getElementById('infoP').textContent = metadata.p;
        document.getElementById('infoActions').textContent = metadata.actions;
      } else {
        document.getElementById('infoDomain').textContent = '-';
        document.getElementById('infoObs').textContent = '-';
        document.getElementById('infoDyn').textContent = '-';
        document.getElementById('infoP').textContent = '-';
        document.getElementById('infoActions').textContent = '-';
      }
    }

    // Update all display elements
    function updateDisplay() {
      if (traceData.length === 0 || currentStepIndex >= traceData.length) {
        return;
      }

      const currentData = traceData[currentStepIndex];
      
      // Update step indicator
      document.getElementById('stepIndicator').textContent = 
        `Step ${currentData.stepId} of ${traceData.length}`;
      
      // Update progress bar
      const progressPercentage = (currentData.stepId / traceData.length) * 100;
      document.getElementById('progressFill').style.width = progressPercentage + '%';
      
      // Update image
      const imageElement = document.getElementById('agentViewImage');
      const placeholderElement = document.getElementById('imagePlaceholder');
      
      imageElement.src = currentData.imageUrl;
      imageElement.style.display = 'block';
      placeholderElement.style.display = 'none';
      
      // Handle image load error
      imageElement.onerror = function() {
        imageElement.style.display = 'none';
        placeholderElement.textContent = 'Image not available';
        placeholderElement.style.display = 'block';
      };
      
      // Update prompt text (design context stays the same, loaded from prompt_0)
      // Don't show feedback card for step 0 (stepId === 1)
      const feedbackCard = document.getElementById('feedbackCard');
      if (currentData.stepId === 1) {
        feedbackCard.style.display = 'none';
      } else {
        feedbackCard.style.display = 'block';
        document.getElementById('promptText').textContent = currentData.promptText;
      }
      
      // Update action output
      document.getElementById('actionOutput').textContent = currentData.actionOutput;
    }

    // Update navigation button states
    function updateNavigationButtons() {
      const isFirst = currentStepIndex === 0;
      const isLast = currentStepIndex >= traceData.length - 1;
      
      document.getElementById('firstButton').disabled = isFirst || traceData.length === 0;
      document.getElementById('prevButton').disabled = isFirst || traceData.length === 0;
      document.getElementById('nextButton').disabled = isLast || traceData.length === 0;
      document.getElementById('lastButton').disabled = isLast || traceData.length === 0;
    }

    // Navigate between steps
    function navigateStep(direction) {
      if (traceData.length === 0) return;
      
      // If manually navigating while playing, pause
      if (isPlaying) {
        stopPlaying();
      }
      
      const newIndex = currentStepIndex + direction;
      
      if (newIndex >= 0 && newIndex < traceData.length) {
        currentStepIndex = newIndex;
        updateDisplay();
        updateNavigationButtons();
      }
    }

    // Navigate to first or last step
    // isAutoPlay: true if called from auto-play loop, false if manual
    function navigateToStep(target, isAutoPlay = false) {
      if (traceData.length === 0) return;
      
      // If manually navigating while playing, pause (unless it's auto-play loop)
      if (isPlaying && !isAutoPlay) {
        stopPlaying();
      }
      
      let newIndex;
      if (target === 0) {
        // Go to first step
        newIndex = 0;
      } else if (target === -1) {
        // Go to last step
        newIndex = traceData.length - 1;
      } else {
        return;
      }
      
      currentStepIndex = newIndex;
      updateDisplay();
      updateNavigationButtons();
    }

    // Start auto-playing
    function startPlaying() {
      if (isPlaying || traceData.length === 0) return;
      
      isPlaying = true;
      updatePlayPauseButton();
      
      // Reset cycle count when starting to play
      stepCycleCount = 0;
      
      playInterval = setInterval(() => {
        if (currentStepIndex < traceData.length - 1) {
          // Auto-play: navigate to next step without pausing
          currentStepIndex++;
          updateDisplay();
          updateNavigationButtons();
        } else {
          // Loop back to first step
          currentStepIndex = 0;
          stepCycleCount++;
          updateDisplay();
          updateNavigationButtons();
          
          // If auto-cycling environments and completed cycles, switch to next environment
          if (isAutoCyclingEnvironments && stepCycleCount >= maxCyclesPerEnvironment) {
            stepCycleCount = 0;
            // Wait a bit then switch to next environment
            setTimeout(() => {
              if (isAutoCyclingEnvironments) {
                currentEnvironmentIndex = (currentEnvironmentIndex + 1) % environments.length;
                loadEnvironment(environments[currentEnvironmentIndex]);
              }
            }, 1000);
          }
        }
      }, playIntervalDelay);
    }

    // Stop auto-playing
    function stopPlaying() {
      if (!isPlaying) return;
      
      isPlaying = false;
      if (playInterval) {
        clearInterval(playInterval);
        playInterval = null;
      }
      updatePlayPauseButton();
    }

    // Toggle play/pause
    function togglePlayPause() {
      if (traceData.length === 0) return;
      
      if (isPlaying) {
        stopPlaying();
      } else {
        startPlaying();
      }
    }

    // Update play/pause button appearance
    function updatePlayPauseButton() {
      const icon = document.getElementById('playPauseIcon');
      
      if (isPlaying) {
        icon.textContent = '⏸';
      } else {
        icon.textContent = '▶';
      }
    }

    // Reset dashboard
    function resetDashboard() {
      stopPlaying();
      traceData = [];
      currentStepIndex = 0;
      designContext = '';
      document.getElementById('stepIndicator').textContent = 'Select an environment to start';
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('imagePlaceholder').textContent = 'No environment selected';
      document.getElementById('imagePlaceholder').style.display = 'block';
      document.getElementById('agentViewImage').style.display = 'none';
      document.getElementById('promptText').textContent = 'Waiting for environment selection...';
      document.getElementById('actionOutput').textContent = '-';
      document.getElementById('designContext').textContent = 'Select an environment to view the task context and goal.';
      document.getElementById('feedbackCard').style.display = 'block';
      updateEnvironmentInfo(null);
      updateNavigationButtons();
      updatePlayPauseButton();
      updateEnvironmentSelection(null);
    }

    // Keyboard navigation support
    document.addEventListener('keydown', function(event) {
      // Prevent navigation if user is typing in an input field
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return;
      }
      
      if (event.key === 'ArrowLeft') {
        event.preventDefault();
        navigateStep(-1);
      } else if (event.key === 'ArrowRight') {
        event.preventDefault();
        navigateStep(1);
      }
    });

    // Update environment card selection
    function updateEnvironmentSelection(envName) {
      const cards = document.querySelectorAll('.environment-card');
      cards.forEach(card => {
        if (card.getAttribute('data-env') === envName) {
          card.classList.add('active');
          // Scroll into view
          card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
          card.classList.remove('active');
        }
      });
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
      // Start auto-cycling through all environments immediately
      startAutoCyclingEnvironments();
    });
    
    // Also try to start immediately if DOM is already loaded
    if (document.readyState !== 'loading') {
      startAutoCyclingEnvironments();
    }
  </script>
</body>
</html>
